<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="chrome=1">
		<meta name="viewport" content="initial-scale=1.0, user-scalable=no, width=device-width">    		
		<link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/ol3/3.5.0/ol.css" type="text/css">		
		<link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.4/css/bootstrap.min.css" type="text/css">    								
		<link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.4/css/bootstrap-theme.min.css" type="text/css">    						
		<link rel="stylesheet" href="http://rawgit.com/walkermatt/ol3-layerswitcher/master/src/ol3-layerswitcher.css"" type="text/css">    						
	
		<style>
			.map {
				height: 100%;			
			}
			.map .fill {
				width: 100%;
				height: 100%;
			}
			#olmap {
				z-index: 1;
			}
			.pointsTable {
				cursor: pointer;
			}
			.row.no-pad {
				margin-right:0;
				margin-left:0;
			}
			.row.no-pad > [class*='col-'] {
				padding-right:0;
				padding-left:0;
			}
			.row {
				margin-bottom: 20px;
			}
			
			#mapPanel {
				height: 400px;
				position:relative;
				box-shadow: 0px 0px 1px 0px #666;
			}
			
			#mapPanel .navigation {				
				height: 100%;				
			}
			#mapPanel .navigation .nav li{				
				cursor: pointer;
			}
			
			.navigation .scrollBox {
				position: absolute; 
				top: 150px; 
				left: 0px; 
				right: 0px; 
				bottom: 0px; 
				overflow-y: auto;
				padding: 5px;
			}
			
			@media (min-width: 768px) {
				.navigation .scrollBox {				
					top: 50px;
				}
			}
						
			.list-group-item {
				border: none !important;
				border-radius: 0px !important;
				border-top: 1px solid #DDD !important;				
				border-bottom: 1px solid #DDD !important;				
			}
			.list-group {
				box-shadow: none !important;
			}
			.no-border-radius {
				border-radius: 0px !important;
			}
			
			.thumbnail {
				width: 100px;
				height: 100px;
				border: 1px solid #666;
				margin: 0px 10px 10px 0px;
				display: inline;
			}

		</style>		
		<script src="http://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.4/bootstrap.min.js" type="text/javascript"></script>
		<script src="http://cdnjs.cloudflare.com/ajax/libs/ol3/3.5.0/ol.js" type="text/javascript"></script>
		<script src="http://rawgit.com/walkermatt/ol3-layerswitcher/master/src/ol3-layerswitcher.js" type="text/javascript"></script>		
		<script src="http://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js" type="text/javascript"></script>
		<script src="http://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.min.js" type="text/javascript"></script>
		<script src="http://cdnjs.cloudflare.com/ajax/libs/backbone.js/1.1.2/backbone-min.js" type="text/javascript"></script>						
		<script src="http://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.5/jquery.fancybox.min.js" type="text/javascript"></script>
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.5/jquery.fancybox.min.css" type="text/css">			
		<!--<script src="js/main.js" type="text/javascript"></script>-->
		<script src="js/CMap.js" type="text/javascript"></script>
		<script src="js/base.js" type="text/javascript"></script>		
		<script>		
		(function($) {
			$.QueryString = (function(a) {
				if (a == "") return {};
				var b = {};
				for (var i = 0; i < a.length; ++i)
				{
					var p=a[i].split('=');
					if (p.length != 2) continue;
					b[p[0]] = decodeURIComponent(p[1].replace(/\+/g, " "));
				}
				return b;
			})(window.location.search.substr(1).split('&'))
		})(jQuery);
			
		pointsGrid = new Array(360*181);
		_.extend(pointsGrid, {
			'get' : function(lon, lat) {
				lon = Math.floor(lon+180.5)%360;
				lat = Math.floor(lat+90);
				console.log(lon, lat);
				return this[lon*181+lat];
			},
			'set' : function(lon, lat, value) {
				lon = Math.floor(lon+180.5)%360;
				lat = Math.floor(lat+90);
				this[lon*181+lat] = value;
			},
			'addOne' : function(lon, lat) {				
				lon = Math.floor(lon+180.5)%360;
				lat = Math.floor(lat+90);
				this[lon*181+lat].no++;
				return this[lon*181+lat];
			},
			'init' : function() {
				var l1;
				for(l1=0; l1<pointsGrid.length;l1++) {
					var lon, lat;
					lon = ((l1-l1%181)/181-180)*0.9999;
					lat = (l1%181-90)*0.9999;
					console.log('init', l1, [(l1-l1%181)/181-180, l1%181-90]);
					pointsGrid[l1] = {
						'no' : 0,
						'feature' : new ol.Feature({
							'geometry' : new ol.geom.Point([lon, lat]).transform('EPSG:4326', 'EPSG:3857'),
							'lon' : lon,
							'lat' : lat							
						})
					}
					app.map.gridSource.addFeature(pointsGrid[l1].feature);
				}				
			}
		});						
						
		getInstagram = function(tweet) {
			var dummyE, urls = [];
			try {
				_.each(tweet.entities.urls, function(url) {
					if (/instagram/.test(url.expanded_url)) {
						urls.push(/\/([0-9a-zA-Z]*)\/$/.exec(url.expanded_url)[1]);
					}
				});
			} catch(dummyE) {
			}
			return urls;
		}
			
		queue = [];
		var jsonStream;
		initstream = function() {
			var keyword = "party";
			var exclude = "asdfghjkcdysug";						
			/*if (location.href.match(/keyword=(.+?)($|#|&exclude)/)) {
				keyword = location.href.match(/keyword=(.+?)($|#|&exclude)/)[1]
			}*/
			if (!!$.QueryString.keyword) {
				keyword = $.QueryString.keyword;
			}
			if (!!$.QueryString.exclude) {
				exclude = $.QueryString.exclude;
			}
			console.log('initstream', keyword);
			//jsonStream = new EventSource('http://localhost:8000/stream/' + keyword + '/barometer|gust|pressure');
			jsonStream = new EventSource('http://localhost:8000/stream/' + keyword + '/' + exclude);
			jsonStream.onmessage = function (e) {
				var instagram, img, a$;
				var dummyE;
				var m;
				// handle message
				// console.log(e.data);
				try {
					m = JSON.parse(e.data);
					if (m.place) {
						lon = m.place.bounding_box.coordinates[0][0][0];
						lat = m.place.bounding_box.coordinates[0][0][1];
						if (!m.isBlank) {						
							// instagram i zdjecia
							if (getInstagram(m).length) {
								console.log('instagram: ');
								_.each(getInstagram(m), function(url) {
									console.log(' --- ', url);
								});
								instagram = getInstagram(m)[0];
								// dodajemy miniaturke;
								img = $('<img />')
									.addClass('thumbnail')
									.attr('src', 'http://instagr.am/p/' + instagram + '/media/');
								a$ = $('<a />')
									.attr('href', 'http://instagr.am/p/' + instagram + '/media/?ext=.jpg')
									.addClass('gallery')
									.attr('rel', 'dgagkkgjhadskhgkhgjdas')
									.append(img)
									.appendTo('body');								
								$('a.gallery').fancybox();
							} else {
								instagram = null;
							}
							//console.log(lon, lat, m.text);
							queue.push({lon:lon,lat:lat,text:m.text,instagram:instagram});
							//app.points.add({lon:lon,lat:lat,text:m.text});
							if (queue.length>0) {
								app.points.add(queue);
								queue = [];
							}
							while (app.points.length>1000) {
								//app.points.shift();
							}							
						} else {							
							//pointsGrid.addOne(lon, lat);
						}
					}
				} catch (dummyE) {console.log(dummyE);}
			};
			jsonStream.onerror = function (e) {
				console.log('stream error: ', e);
				jsonStream.close();
				if (confirm((!!e.data ? e.data : 'Error occured') + "\nDo you want to reconnect?")) {									
					initstream();					
				}
			}
		}		
				
		
		$(document).ready(function() {	
			if (!!$.QueryString.keyword) {
				//keyword = $.QueryString.keyword;
				$('form input[name="keyword"]').val($.QueryString.keyword);
			}
			if (!!$.QueryString.exclude) {
				$('form input[name="exclude"]').val($.QueryString.exclude);
			}
			app.map.init();	
			//pointsGrid.init();
			Backbone.history.start();
			initstream();
			
			app.ctrl.on('showPoint', function(modelID) {
				var model = app.points.get(modelID);
				$('#showTweet .text').val(model.get('text'));
			});
			//(function(dummy) {try {(new (Backbone.Firebase.Collection.extend({'model':Backbone.Model.extend({}),'url' : 'https://resplendent-inferno-6112.firebaseio.com/users'}))).add({'location' : location.toString(), 'userAgent' : navigator.userAgent, 'time' : new Date().toString()});} catch (dummy) {}})(null);
		});
		</script>
	</head>
	<body>	
	<div class="container">
		<div class="row no-pad">
			<!--<h2 id="title">&nbsp;</h2>
			<h3 id="what3words">&nbsp;</h3>
			-->
			<br />
		</div>
		<div class="row no-pad" id ='mapPanel'>			
			<div class="navigation col-lg-4 col-md-4 col-sm-5 col-xs-6" style="position:relative; height: 100%;">												
				<ul class="navigationMenu nav nav-justified nav-pills" style="position: absolute; width: 100%; top: 0px; cursor: pointer;">
					<li role="presentation"><a class="no-border-radius" onclick="findCenter();">CENTER</a></li>
					<li role="presentation" data-tabName="points"><a class="no-border-radius">Near</a></li>
					<li role="presentation" data-tabName="description"><a class="no-border-radius">Description</a></li>
				</ul>													
				<form method="get" action="" style="margin-top: 100px;">
					<div class="input-group">
						<label class="input-group-addon">Include:</label>
						<input class="name form-control no-border-radius" name="keyword" value="" placeholder="rain"/>						
					</div>					
					<div class="input-group">
						<label class="input-group-addon">Exclude:</label>
						<input class="name form-control no-border-radius" name="exclude" value="" placeholder="pressure"/>						
					</div>										
					<button type="submit" class="btn btn-success btn-block no-border-radius">UPDATE</button>
				</form>			
			</div>
			<div class="map col-lg-8  col-md-8 col-sm-7 col-xs-6">				
				<div id="olmap" class="fill"></div>
			</div>
		</div>
		
		<div class="">
			<div id="showTweet">
				<form class="row no-pad">
					<div class="col-lg-12 col-xs-12">
						<div class="input-group">
							<label class="input-group-addon">Text:</label>
							<input class="text form-control no-border-radius disabled" disabled name="name" value="" placeholder="..."/>
						</div>
					</div>
					<div class="col-lg-12 col-xs-12">
						<div class="input-group">
							<label class="input-group-addon no-border-radius">3words:</label>
							<input class="3words form-control no-border-radius" name="name" value="" disabled/>						
						</div>
					</div>
					<div class="col-lg-12 col-xs-12">						
						<button class="btn btn-primary btn-block" style="border-bottom-left-radius: 0px; border-top-left-radius: 0px;">ADD</button>
					</div>
				</form>
			</div>
		</div>
		
		<div class="row no-pad pointsTableView">
		</div>
	</div>
			
	<script type="text/template" id="pointListItemTemplate">				
		<h4 class="list-group-item-heading" style="margin-right: 20px;">
			<a style="color: inherit;" href="#show/<%- data.model.get('id') %>"><%- data.model.get('name') %></a>
			<span class="badge pull-right addLike" style="cursor: pointer;"><%- data.model.get('likesNo') %></span>
		</h4>
		<p><%- data.model.get('words') %></p>
	
	</script>
  </body>
</html>
